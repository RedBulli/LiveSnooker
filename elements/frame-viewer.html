<link rel="import" href="../vendors/polymer/polymer.html">
<link rel="import" href="frame-score-view.html">
<link rel="import" href="break-history-view.html">
<link rel="import" href="live-snooker-api.html">
<link rel="import" href="event-stream.html">
<link rel="import" href="p2p-video.html">
<link rel="import" href="frame-novideo-view.html">

<dom-module id="frame-viewer">
  <style>
    #gameview {
      width: 640px;
    }

    #on-video-score {
      position: relative;
      top: -2em;
      text-align: center;
    }
  </style>

  <link rel="stylesheet" href="css/foundation.min.css">

  <template>
    <live-snooker-api id="api"></live-snooker-api>
    <template is="dom-if" if="{{frame}}">
      <event-stream stream-url="{{streamUrl}}" on-event="onStreamEvent"></event-stream>
      <div class="row">
        <div class="large-8 columns">
          <div id="gameview">
            <template is="dom-if" if="{{video}}">
              <p2p-video league-id="{{frame.attributes.League.id}}" frame-id="{{frame.id}}"></p2p-video>
              <frame-score-view id="on-video-score" frame="{{frame}}"></frame-score-view>
            </template>
            <template is="dom-if" if="{{!video}}">
              <frame-novideo-view frame="{{frame}}"></frame-novideo-view>
            </template>
          </div>
        </div>
        <div class="large-4 columns">
          <break-history-view class="hidden-for-medium-down" breaks="{{frame.attributes.shotGroups}}"></break-history-view>
        </div>
      </div>
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'frame-viewer',
    properties: {
      frame: Object,
      frameId: {
        type: String,
        observer: '_frameIdChanged'
      },
      streamUrl: String
    },
    _frameIdChanged: function() {
      var frame = new Frame({id: this.frameId});
      frame.setApiClient(this.$.api);
      frame.fetch({
        success: (function() {
          frame.get('Shots').populateAssociations();
          frame.calculateShotGroups();
          this.frame = frame;
        }).bind(this)
      });
    },
    onStreamEvent: function(event) {
      this.frame.newShot(event.detail.shot);
    },
    ready: function() {
      this.streamUrl = this.$.api.host + "/framestream";
    }
  });
</script>
