<link rel="import" href="../vendors/polymer/polymer.html">
<link rel="import" href="livesnooker-api.html">
<link rel="import" href="event-stream.html">
<link rel="import" href="stream-channel.html">
<link rel="import" href="../vendors/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="uikit.html">
<link rel="import" href="x-frame-view.html">

<dom-module id="frame-viewer">
  <template>
    <livesnooker-api id="api"></livesnooker-api>
    <template is="dom-if" if="[[frame]]">
      <div class="uk-grid">
        <div class="uk-width-medium-4-5">
          <event-stream stream-url="[[streamUrl]]" on-event="onStreamEvent"></event-stream>
          <stream-channel id="stream-channel" socket-url="[[socketUrl]]" league-id="[[frame.attributes.League.id]]" on-new-stream="newStream" on-stream-closed="streamClosed"></stream-channel>
          <x-frame-view socket-url="[[socketUrl]]" frame="[[frame]]" video="[[video]]"></x-frame-view>
          <template is="dom-if" if="[[videoAvailable]]">
            Video: <paper-toggle-button id="video-toggle" on-change="videoToggleChanged"></paper-toggle-button>
          </template>
          <template is="dom-if" if="[[!videoAvailable]]">
            Video not available.
          </template>
        </div>
        <div id="breaks" class="uk-width-medium-1-5">
          <break-history-view breaks="[[frame.attributes.shotGroups]]"></break-history-view>
        </div>
      </div>
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'frame-viewer',
    properties: {
      frame: Object,
      frameId: {
        type: String,
        observer: '_frameIdChanged'
      },
      streamUrl: String,
      socketUrl: String,
      video: {
        type: Boolean,
        value: false
      },
      videoAvailable: {
        type: Boolean,
        value: false
      }
    },
    _frameIdChanged: function() {
      var _this = this;
      this.$.api.findOrFetchModel(Frame, this.frameId)
        .then(function(frame) {
          frame.get('Shots').populateAssociations();
          frame.calculateShotGroups();
          _this.frame = frame;
          _this.streamUrl = _this.$.api.host + "/framestream/" + _this.frameId;
        });
    },
    newStream: function(event) {
      if (event.detail == this.frameId) {
        this.videoAvailable = true;
      }
    },
    streamClosed: function(event) {
      if (event.detail == this.frameId) {
        this.videoAvailable = false;
      }
    },
    videoToggleChanged: function(event) {
      this.video = event.srcElement.checked;
    },
    onStreamEvent: function(event) {
      if (event.detail.event === "newShot") {
        this.frame.addShot(this.frame.initializeShot(event.detail.shot));
      }
      else if (event.detail.event === "deleteShot") {
        this.frame.deleteShot(event.detail.shot.id);
      }
    }
  });
</script>
