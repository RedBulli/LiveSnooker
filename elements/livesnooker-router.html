<link rel="import" href="../vendors/polymer/polymer.html">
<link rel="import" href="uikit.html">
<link rel="import" href="livesnooker-api.html">
<link rel="import" href="livesnooker-home.html">
<link rel="import" href="../vendors/iron-pages/iron-pages.html">
<link rel="import" href="league-controller.html">
<link rel="import" href="livesnooker-user.html">
<link rel="import" href="leagues-list.html">
<link rel="import" href="livesnooker-toolbar.html">
<link rel="import" href="../vendors/google-signin/google-signin.html">
<script src="../vendors/page/page.js"></script>

<dom-module id="livesnooker-router">
  <template>
    <livesnooker-api id="api" host="{{backendHost}}"></livesnooker-api>
    <google-signin client-id="{{googleClientId}}" signed-in="{{signedIn}}" hidden$="{{signedIn}}" on-google-signin-success="onSignedIn"></google-signin>
    <a id="noauth" on-click="noAuthClicked">Use anonymously</a>
    <header>
      <livesnooker-toolbar></livesnooker-toolbar>
    </header>
    <iron-pages attr-for-selected="route" selected="[[route]]">
        <section route="live"><livesnooker-home league-id="{{routeParams.leagueId}}" socket-url="[[socketUrl]]"></livesnooker-home></section>
      <section route="leagues"><leagues-list></leagues-list></section>
      <section route="league"><league-controller league-id="{{routeParams.leagueId}}"></league-controller></section>
      <section route="user"><livesnooker-user></livesnooker-user></section>
      <section route="404">Not found</section>
    </iron-pages>
  </template>
</dom-module>

<script>
  function initRoutes(callback) {
    window.addEventListener('WebComponentsReady', function() {
      var baseUrl = '';
      page.base('');
      if (window.location.port === '') {  // if production
        page.base(baseUrl.replace(/\/$/, ''));
      }
      page('/', function() {
        page.redirect('/leagues');
      });
      page(baseUrl, function() {
        page.redirect('/leagues');
      });
      page('/live/:leagueId', function(data) {
        callback('live', data.params);
      });
      page('/user', function() {
        callback('user');
      });
      page('/leagues', function() {
        callback('leagues');
      });
      page('/league/:leagueId', function(data) {
        callback('league', data.params);
      });
      page('*', function() {
        callback('404');
      });
      // add #! before urls
      page({
        hashbang: true
      });
    });
  }

  Polymer({
    is: 'livesnooker-router',
    properties: {
      signedIn: Boolean,
      backendHost: String,
      googleClientId: String,
      socketUrl: String,
      route: Object
    },
    onSignedIn: function() {
      this.$.noauth.hidden = true;
      this.$.noauth.innerHTML = "Using anonymously";
    },
    noAuthClicked: function(event) {
      event.preventDefault();
      this.$.api.useAnonymously();
    },
    setRoute: function(route, params) {
      this.route = route;
      this.routeParams = params;
    },
    ready: function() {
      initRoutes(this.setRoute.bind(this));
    }
  });
</script>
