<link rel="import" href="../vendors/polymer/polymer.html">

<dom-module id="backbone-collection-renderer">
  <template>
    <content id="content"></content>
  </template>
</dom-module>

<script>
  function bindCollectionChangesToPolymerArray(collection, variableName, element) {
    function resetArray() {
      element.splice(variableName, 0, element[variableName].length);
      element.async(function () {
        element.splice.bind(element, variableName, 0, 0).apply(element, collection.models);
      }, 0);
    }

    function resetByIteration() {
      element.splice(variableName, 0, element[variableName].length);
      element.async(function () {
        collection.each(function(model) {
          element.push(variableName, model);
        });
      }, 0);
    }

    collection.on('add remove change reset', resetArray, element);
    resetArray();
  }

  Polymer({
    is: 'backbone-collection-renderer',
    properties: {
      collection: {
        type: Object,
        observer: '_onCollectionChange'
      },
      models: {
        type: Array,
        value: function() {return [];}
      }
    },
    _onCollectionChange: function(next, prev) {
      if (prev) {
        prev.off(null, null, this); // Remove all callbacks with this context
      }
      next.on("add remove change reset", this.renderModelsToTemplate, this);
      this.renderModelsToTemplate();
    },
    reset: function(el) {
      var reset = el.splice.bind(el, 'items', 0, el.items.length);
      reset.apply(el, this.collection.models);
    },
    resetByIteration: function(el) {
      el.splice('items', 0, el.items.length);
      this.collection.each(function(model) {
        el.push('items', model);
      });
    },
    renderModelsToTemplate: function() {
      var el = Polymer.dom(this).node.querySelector(".content");
      if (el) {
        if (!el.items) {
          el.items = [];
        }
        this.reset(el);
      }
    }
  });
</script>
