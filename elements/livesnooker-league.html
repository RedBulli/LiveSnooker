<link rel="import" href="../vendors/polymer/polymer.html">
<link rel="import" href="live-snooker-api.html">
<link rel="import" href="js/player.html">
<link rel="import" href="js/league.html">

<polymer-element name="livesnooker-league" attributes="league">
  <template id="template">
    <live-snooker-api id="api"></live-snooker-api>
    <div id="league">
      <template if="{{ league }}">
        <h2>{{league.attributes.name}}</h2>

        <ul>
          <li>ID: {{league.id}}</li>
          <li>Players:
            <ul>
              <template repeat="{{ player in league.attributes.Players.models }}">
                <li>{{ player.attributes.name }}</li>
              </template>
            </ul>
          </li>
        </ul>
        <form>
          <label for="name">Add a new player: </label>
          <input type="text" id="playerName" name="name" placeholder="Name">
          <button on-click="{{ newPlayer }}">Create player</button>
          <validation-errors id="errors"></validation-errors>
        </form>
      </template>
      <template if="{{ error }}">
        {{ error }}
      </template>
    </div>
  </template>
  <script>
    Polymer({
      newPlayer: function() {
        var _this = this;
        var errorsEl = this.$.errors;
        event.preventDefault();
        var uuid = createUuid();
        var playerInput = this.$.league.querySelector('#playerName');
        var opts = {
          uuid: uuid,
          name: playerInput.value,
          LeagueId: this.league.id
        };
        var player = new Player(opts);
        player.setApiClient(this.$.api);
        player.save(player.attributes, {
          success: function(model) {
            _this.league.get('Players').add(model);
            playerInput.value = "";
          },
          error: function(data, response) {
            errorsEl.errors = response.responseJSON.error.errors;
          }
        });
      },
      domReady: function() {
        if (!this.league) {
          var _this = this;
          this.$.api.findOrFetchModel(League, this.leagueId)
            .then(function(league) {
              _this.league = league;
            })
            .catch(function(model, response)Â {
              _this.error = response.status;
            });
        }
      }
    });
  </script>
</polymer-element>
