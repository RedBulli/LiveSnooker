<link rel="import" href="../vendors/polymer/polymer.html">
<link rel="import" href="live-snooker-api.html">
<link rel="import" href="js/frame.html">
<link rel="import" href="js/players.html">
<link rel="import" href="new-frame-form.html">
<link rel="import" href="js/league.html">
<link rel="import" href="stream-channel.html">
<link rel="import" href="js/vendor/jquery.html">

<polymer-element name="live-snooker" attributes="league">
  <template>
    <style>
      .video-status {
        display: none;
      }
    </style>
    <live-snooker-api id="api"></live-snooker-api>
    <stream-channel id="stream-channel" leagueId="{{leagueId}}" on-new-stream="{{newStream}}" on-stream-closed="{{streamClosed}}"></stream-channel>
    <ol id="framelist">
      <template repeat="{{ frame in league.attributes.Frames.models}}" id="frames">
        <li data-id="{{frame.id}}">
          {{frame.attributes.Player1.attributes.name}} - {{frame.attributes.Player2.attributes.name}}
          <a href="/frame.html?frameId={{ frame.id }}&input=false&video=false" on-click="{{ showFrame }}">Show</a>
          <a href="/frame.html?frameId={{ frame.id }}&input=true&video=false" on-click="{{ controlFrame }}">Control</a>
          <span class="video-status">VIDEO</span>
        </li>
      </template>
    </ol>
    Create a new frame <br>
    <new-frame-form league="{{league}}"></new-frame-form>
  </template>
  <script>
    function routeToLeague(router) {
      if (localStorage.leagueId) router.go('/' + localStorage.leagueId);
      else router.go('/leagues/');
    }

    Polymer({
      getVideoStatusElement: function(frameId) {
        return $(this.$.framelist.querySelector('li[data-id="' + frameId + '"] > .video-status'));
      },
      showFrame: function() {
        event.preventDefault();
        window.open(event.currentTarget.href, "", "width=1050, height=600");
      },
      controlFrame: function(event) {
        event.preventDefault();
        window.open(event.currentTarget.href, "", "width=1050, height=600");
      },
      newStream: function(event) {
        this.getVideoStatusElement(event.detail).show();
      },
      streamClosed: function(event) {
        this.getVideoStatusElement(event.detail).hide();
      },
      domReady: function() {
        if (this.leagueId) localStorage.leagueId = this.leagueId;
        else {
          routeToLeague(this.router);
          return;
        }
        this.noleague = "Loading!";
        var _this = this;
        if (!this.league) {
          this.$.api.findOrFetchModel(League, this.leagueId)
            .then(function(league) {
              _this.league = league;
              _this.router.templateInstance.model.league = league;
            })
            .catch(function(model, response)Â {
              _this.noleague = response.responseJSON.error.message;
            });
        }
      }
    });
  </script>
</polymer-element>
