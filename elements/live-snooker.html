<link rel="import" href="../vendors/polymer/polymer.html">
<link rel="import" href="live-snooker-api.html">
<link rel="import" href="live-snooker-frame.html">
<link rel="import" href="js/frame.html">
<link rel="import" href="js/players.html">
<link rel="import" href="new-frame-form.html">
<link rel="import" href="js/league.html">

<polymer-element name="live-snooker" attributes="league">
  <template>
    <live-snooker-api id="api"></live-snooker-api>
    <template if="{{ league }}">
      <ol>
        <template repeat="{{ frame in league.attributes.Frames.models}}">
        <li>
          {{frame.attributes.Player1.attributes.name}} - {{frame.attributes.Player2.attributes.name}}
          <a href="/frame.html?frameId={{ frame.id }}" on-click="{{ showFrame }}">Show</a>
          <a href="/frame.html?frameId={{ frame.id }}" on-click="{{ controlFrame }}">Control</a>
        </li>
        </template>
      </ol>
      Create a new frame <br>
      <new-frame-form league="{{league}}"></new-frame-form>
    </template>
    <template if="{{ !league }}">
      {{ noleague }}
    </template>
  </template>
  <script>
    function routeToLeague(router) {
      if (localStorage.leagueId) router.go('/' + localStorage.leagueId);
      else router.go('/leagues/');
    }
    Polymer({
      showFrame: function() {
        event.preventDefault();
        window.open(event.currentTarget.href, "", "width=800, height=600")
      },
      controlFrame: function(event) {
        event.preventDefault();
        window.open(event.currentTarget.href, "", "width=800, height=600")
      },
      domReady: function() {
        if (this.leagueId) localStorage.leagueId = this.leagueId;
        else {
          routeToLeague(this.router);
          return;
        }
        this.noleague = "Loading!";
        var _this = this;
        if (!this.league) {
          this.$.api.findOrFetchModel(League, this.leagueId)
            .then(function(league) {
              _this.league = league;
              _this.router.templateInstance.model.league = league;
            })
            .catch(function(model, response)Â {
              _this.noleague = response.responseJSON.error.message;
            });
        }
      }
    });
  </script>
</polymer-element>
